/**
  postmate - A powerful, simple, promise-based postMessage library
  @version v1.4.1
  @link https://github.com/dollarshaveclub/postmate
  @author Jacob Kelley <jakie8@gmail.com>
  @license MIT
**/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Postmate=t()}(this,function(){"use strict";var h="application/x-postmate-v1+json",d=Object.prototype.hasOwnProperty,r=0,l=function(e,t){return e.origin===t&&("object"==typeof e.data&&("postmate"in e.data&&(e.data.type===h&&!!{"handshake-reply":1,call:1,emit:1,reply:1,request:1}[e.data.postmate])))},i=function(){function e(){}var t=e.prototype;return t.init=function(e){var a=this;this.parent=e.parent,this.frame=e.frame,this.child=e.child,this.childOrigin=e.childOrigin,this.events={},this.listener=function(e){var t=((e||{}).data||{}).value||{},n=t.data,i=t.name;"emit"===e.data.postmate&&a.events&&i in a.events&&a.events[i].call(a,n)},this.parent.addEventListener("message",this.listener,!1)},t.get=function(e){var a=this;return new c.Promise(function(n){var i=++r;a.parent.addEventListener("message",function e(t){t.data.uid===i&&"reply"===t.data.postmate&&(a.parent.removeEventListener("message",e,!1),n(t.data.value))},!1),a.child.postMessage({postmate:"request",type:h,property:e,uid:i},a.childOrigin)})},t.call=function(e,t){this.child&&this.child.postMessage({postmate:"call",type:h,property:e,data:t},this.childOrigin)},t.on=function(e,t){this.events&&(this.events[e]=t)},t.destroy=function(){window.removeEventListener("message",this.listener,!1),this.parent&&this.parent.removeEventListener("message",this.listener,!1),this.frame&&this.frame.parentNode.removeChild(this.frame),this.events=null},e}(),p=function(){function e(e){var d=this;this.model=e.model,this.parent=e.parent,this.parentOrigin=e.parentOrigin,this.child=e.child,this.child.addEventListener("message",function(t){if(l(t,d.parentOrigin)){var e,n,i,a=t.data,r=a.property,s=a.uid,o=a.data;if("call"!==t.data.postmate)(e=d.model,n=r,i="function"==typeof e[n]?e[n]():e[n],c.Promise.resolve(i)).then(function(e){return t.source.postMessage({property:r,postmate:"reply",type:h,uid:s,value:e},t.origin)});else r in d.model&&"function"==typeof d.model[r]&&d.model[r].call(d,o)}})}return e.prototype.emit=function(e,t){this.parent.postMessage({postmate:"emit",type:h,value:{name:e,data:t}},this.parentOrigin)},e}(),c=function(){function n(e){var t=void 0===e?userOptions:e,n=t.container,i=void 0===n?void 0!==i?i:document.body:n,a=t.model,r=t.url;return this.parent=window,this.frame=document.createElement("iframe"),i.appendChild(this.frame),this.child=this.frame.contentWindow||this.frame.contentDocument.parentWindow,this.model=a||{},this.sendHandshake(r)}return n.prototype.sendHandshake=function(a){var e,t,r,s=this,o=(e=a,(t=document.createElement("a")).href=e,t.origin||t.protocol+"//"+t.hostname),d=0,p=new i;return{parentAPI:p,promise:new n.Promise(function(n,i){s.parent.addEventListener("message",function e(t){return!!l(t,o)&&("handshake-reply"===t.data.postmate?(clearInterval(r),s.parent.removeEventListener("message",e,!1),s.childOrigin=t.origin,p.init.call(p,s),n(p)):i("Failed handshake"))},!1);var e=function(){d++,s.child.postMessage({postmate:"handshake",type:h,model:s.model},o),5===d&&clearInterval(r)},t=function(){e(),r=setInterval(e,500)};s.frame.attachEvent?s.frame.attachEvent("onload",t):s.frame.onload=t,s.frame.src=a})}},n}();return c.debug=!1,c.Promise=function(){try{return window?window.Promise:Promise}catch(e){return null}}(),c.Model=function(){function e(e){return this.child=window,this.model=e,this.parent=this.child.parent,this.sendHandshakeReply()}return e.prototype.sendHandshakeReply=function(){var o=this;return new c.Promise(function(r,s){o.child.addEventListener("message",function e(t){if(t.data.postmate){if("handshake"===t.data.postmate){o.child.removeEventListener("message",e,!1),t.source.postMessage({postmate:"handshake-reply",type:h},t.origin),o.parentOrigin=t.origin;var n=t.data.model;if(n)for(var i=Object.keys(n),a=0;a<i.length;a++)d.call(n,i[a])&&(o.model[i[a]]=n[i[a]]);return r(new p(o))}return s("Handshake Reply Failed")}},!1)})},e}(),c});
